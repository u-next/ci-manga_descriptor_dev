# Manga Agent Descriptor Development

[🇺🇸 English](README.md) | [🇯🇵 日本語](#japanese)

<a name="japanese"></a>

漫画説明生成システムのモジュラーで保守可能なリファクタリング。このプロジェクトは、モノリシックなmanga_agent_runner.py（2000行以上）を、包括的な集約ログ機能を備えたクリーンでテスト可能なアーキテクチャに変換します。

## 🎯 プロジェクト概要

**ソースシステム**: ci-manga_description_generation
- 2000行以上のモノリシックなmanga_agent_runner.py
- 273行の単一ワークフロー関数
- 散在するハードコーディングされた値
- 本番稼動対応だが保守困難

**ターゲットシステム**: ci-manga_descriptor_dev
- 関心の分離を伴うモジュラーアーキテクチャ
- 明確なインターフェースを持つテスト可能なコンポーネント
- 設定駆動型アプローチ
- 機能性とパフォーマンスの維持

## 📁 プロジェクト構造

### 現在の実装 (v1.0.0 - **完了**)
```
ci-manga_descriptor_dev/
├── main/                      # メイン開発ブランチ (git worktree)
│   ├── README.md              # このファイル
│   ├── README_ja.md           # 日本語版
│   ├── SHORT_TERM_REFACTORING_PLAN.md  # リファクタリング戦略 
│   ├── .env                   # 環境設定（セキュア）
│   ├── .gitignore             # セキュリティとビルド除外
│   ├── __init__.py            # パッケージ初期化
│   ├── example_usage.py       # 全コンポーネントのデモンストレーション
│   ├── run_tests.py           # テストランナー
│   ├── logs/                  # 集約ログ出力
│   ├── test_output/           # テスト結果と生成ファイル
│   └── tests/                 # 包括的テストスイート
│       ├── test_basic_functions.py           # コンポーネント検証
│       ├── test_logging_gcp.py               # GCPログ統合
│       └── test_full_logging_integration.py  # エンドツーエンドログテスト
└── refactor/                  # リファクタリングされたモジュール (git worktree)
    ├── infrastructure/
    │   ├── __init__.py        # インフラストラクチャモジュール
    │   └── gcp_setup.py       # GCP認証、Vertex AI（ログ付き）
    ├── io/
    │   ├── __init__.py        # I/Oモジュール  
    │   ├── data_loader.py     # CSV読み込み＆DataFrame準備（ログ付き）
    │   └── output_manager.py  # GCS/ローカル保存＆メトリクス（ログ付き）
    ├── processing/
    │   ├── __init__.py        # 処理モジュール
    │   ├── workflow.py        # ワークフローオーケストレーション（ログ付き）
    │   └── README.md          # 処理ドキュメンテーション
    ├── utils/
    │   ├── __init__.py        # ユーティリティモジュール
    │   ├── content_detection.py # アダルトコンテンツ、同人誌検出
    │   ├── title_processing.py  # タイトルクリーニング、バリエーション
    │   ├── json_extraction.py   # JSON解析ユーティリティ
    │   ├── logging.py         # **新機能**: 集約ログシステム
    │   └── README.md          # ユーティリティドキュメンテーション
    └── models/
        ├── __init__.py
        ├── config.py          # モデル設定（ログ付き）
        ├── workflow_results.py # 結果処理
        └── README.md          # AIモデル操作
```

## 🚀 クイックスタート

### 前提条件

1. **ソースシステムアクセス**: ci-manga_description_generationリポジトリへのアクセス
2. **Python環境**: Python 3.8+、必要な依存関係
3. **Google Cloud**: 適切な権限での認証済みアクセス
4. **micromamba環境**: colab_env環境の設定

### 開発セットアップ

```bash
# リポジトリをクローン
git clone <repository-url>
cd ci-manga_descriptor_dev/main

# Google Cloudで認証
gcloud auth application-default login
gcloud config set project unext-ai-sandbox

# テストの実行（colab_env環境を使用）
micromamba run -n colab_env python tests/test_full_logging_integration.py
```

## 📋 リファクタリングステータス

### ✅ **完了 - 全目標達成** 
- [x] **システム分析**: ソースシステムの包括的分析 ✅
- [x] **アーキテクチャ設計**: Git worktreeアーキテクチャとモジュラー設計 ✅  
- [x] **ドキュメンテーション**: 包括的リファクタリング計画と多言語ドキュメント ✅
- [x] **ユーティリティ抽出**: すべてのコアユーティリティを抽出・テスト完了 ✅
  - [x] コンテンツ検出（アダルトコンテンツ、同人誌検出）
  - [x] タイトル処理（クリーニング、バリエーション）
  - [x] JSON抽出（堅牢な解析ユーティリティ）
- [x] **インフラストラクチャ設定**: 完全なGCPと認証システム ✅
  - [x] 環境ベース設定（.envサポート）
  - [x] GCP認証とプロジェクト切り替え（unext-ai-sandbox）
  - [x] Vertex AI初期化とログ
- [x] **I/O操作**: 完全なデータパイプライン実装 ✅
  - [x] フォーマット検出付きCSV読み込み（旧/新）
  - [x] DataFrame準備と検証
  - [x] GCSとローカル出力管理とメトリクス
- [x] **ワークフローオーケストレーション**: 完全なワークフローシステム ✅
  - [x] パイプラインステージ管理とコンテキストマネージャー
  - [x] パフォーマンス追跡とメトリクス収集
  - [x] エラーハンドリングと復旧メカニズム
- [x] **モデルコンポーネント**: 設定と結果処理 ✅
  - [x] モデル設定クラス
  - [x] ワークフロー結果コンテナ
  - [x] 安全性設定とモデル管理
- [x] **🎯 中核機能: 集約ログシステム** ✅
  - [x] 全モジュール統一ログ
  - [x] タイミングデコレータによるパフォーマンス追跡
  - [x] コンテキストマネージャーによるパイプラインステージログ
  - [x] 構造化ログ（GCP、データ、モデル操作）
  - [x] タイムスタンプ付きログファイルと包括的出力
- [x] **テストインフラストラクチャ**: 完全なテストスイート ✅
  - [x] コンポーネント検証テスト
  - [x] GCP統合テスト
  - [x] エンドツーエンドログ統合テスト
  - [x] 包括的カバレッジで全テスト合格
- [x] **セキュリティ＆設定**: 本番対応セットアップ ✅
  - [x] 環境変数設定
  - [x] セキュリティ除外付き.gitignore
  - [x] セキュアな認証情報管理

### 🏆 **当初計画を超えた主要成果**
- [x] **Git Worktreeアーキテクチャ**: プロフェッショナルな開発セットアップ
- [x] **包括的ログ**: エンタープライズグレードのログシステム
- [x] **完全なテストカバレッジ**: 全モジュールのテストと検証
- [x] **セキュリティ実装**: 本番対応のセキュリティプラクティス
- [x] **多言語ドキュメンテーション**: 英語＋日本語サポート

## 🔧 主要機能

### 現在のシステムの強み（保持）
- ✅ **マルチモデルアプローチ**: 4つのジェネレーター + 1つのジャッジでコンセンサス
- ✅ **Grounding統合**: 事実の正確性のためのGoogle GenAI SDK
- ✅ **構造化出力**: バリデーション付きPydanticスキーマ
- ✅ **バッチ処理**: スレッドベースの並列化
- ✅ **本番対応**: 堅牢なエラーハンドリングとログ

### 改良点（ターゲット）
- 🎯 **モジュラー設計**: 明確な関心の分離
- 🎯 **テスト可能なコンポーネント**: ユニットテスト可能な関数とクラス
- 🎯 **設定駆動**: 集約的な設定管理
- 🎯 **強化されたエラーハンドリング**: サーキットブレーカーとリトライメカニズム
- 🎯 **包括的テスト**: >80%のテストカバレッジ
- 🎯 **開発者体験**: より高速な反復とデバッグ

## 📊 成功指標

### 技術指標
- **保守性**: 関数<50行、複雑度<10
- **テスタビリティ**: >80%のユニットテストカバレッジ
- **パフォーマンス**: 現在のパフォーマンスから<20%の退行
- **信頼性**: 既存のワークフローすべてが継続して機能

### 運用指標  
- **開発速度**: より高速な機能反復
- **デバッグ可能性**: より簡単な問題の分離と解決
- **コードレビュー効率**: より小さく集中した変更
- **チームオンボーディング**: より明確なコード構造

## 🚀 テスト実行

### 基本テスト
```bash
# コンポーネントテスト
micromamba run -n colab_env python tests/test_basic_functions.py

# GCPログテスト  
micromamba run -n colab_env python tests/test_logging_gcp.py

# 包括的統合テスト
micromamba run -n colab_env python tests/test_full_logging_integration.py
```

### ログファイル確認
```bash
# 生成されたログを確認
ls -la logs/
cat logs/manga_agent_runner_*.log

# テスト出力を確認
ls -la test_output/
```

## 🔍 重要な成果

### 集約ログシステム
- **🚀 システム初期化**: GCP認証、Vertex AI設定
- **☁️ GCPオペレーション**: 認証、プロジェクト管理、サービス初期化
- **🏗️ パイプラインステージ**: タイミング付きエントリ/エグジットログ
- **📊 データ操作**: ファイルサイズ、行数、メトリクス
- **🧠 モデル操作**: AI相互作用、トークン使用量
- **⏱️ パフォーマンス追跡**: 全関数の実行時間

### Git Worktreeアーキテクチャ
- **main/**: メイン開発ブランチ
- **refactor/**: リファクタリングされたモジュール
- **並列開発**: 異なるドメインでの同時作業
- **分離された関心**: モジュール間の明確な境界

## 🆘 サポート

### ヘルプの取得
- **ドキュメンテーション**: 各モジュールの関連READMEファイルを確認
- **Issue**: バグや機能要求についてはGitHub issueを作成
- **コードレビュー**: 重要な変更についてはレビューを要求
- **アーキテクチャの質問**: チームミーティングまたはドキュメンテーション更新で議論

### よくある問題
- **インポートエラー**: モジュール構造と__init__.pyファイルを確認
- **設定問題**: config.py設定がソースシステムと一致することを確認
- **パフォーマンス退行**: ベンチマークテストを実行し、メトリクスを比較
- **テスト失敗**: テストフィクスチャとモック設定を確認

## 📄 ライセンス

このプロジェクトは、ソース漫画説明生成システムのライセンスを継承します。

---

**チーム開発プロジェクト**: このリファクタリングは協調的開発のために設計されています。プルリクエストを通じて変更を調整し、チームメンバーのために包括的なドキュメンテーションを維持してください。